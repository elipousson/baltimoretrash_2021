---
title: "Trash related service requests and ECB citations"
output: rmdformats::downcute
css: "style_sheet.css"
params:
  area_name: ["Ellwood Park/Monument"]  #, "Baltimore Highlands"
  area_type: "neighborhood"
  year_start: 2016
  # If union is TRUE, the union_name is required
  union: FALSE # TRUE
  union_name: NULL
  # Map parameters
  asp: "9:6.25" # "17:11"  # "3:2"  # "16:9"
  diag_ratio: 0.08
---
:::::{id="body"}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = TRUE)

library(sf)
library(mapbaltimore)
library(ggplot2)
library(dplyr)
library(stringr)
library(lubridate)
library(patchwork)
library(gt)

# Set default theme
theme_set(theme_minimal())
```

```{r pull_scripts}
#Gets the area type, name, nearby areas, and area outline (or Union info if applicable).
source('get_area_script.R')

#Gets selected type of requests, 6-months prior, area request info, and nearby areas request info. 
source('get_requests_script.R')

#Gets citations based on area type, provides citation source, area citations info, and nearby areas citations info.
source('get_citations_script.R')

#Gets blocks from the chosen area
source('get_area_blocks_script.R')
```

::::{id="main_maps"}
```{r city_and_neighborhood_maps}
#Creates map of Baltimore City.
city_map <- ggplot() +
  geom_sf(data = baltimore_city, fill = "grey") +
  geom_sf(data = neighborhoods, fill = NA, color = "black") +
  geom_sf(data = area, fill = "red", color = "red") +
  geom_sf(data = baltimore_city, size = 1, color = "black", fill = NA) +
  ggtitle("Baltimore City") +
  theme_void()


#Creates map of neighborhood.
area_map <- ggplot() +
  layer_area_data(area = area, data = parks, fill = "forestgreen", alpha = 0.8) +
  layer_area_streets(area = area, color = "gray85") +
  geom_sf(data = area, color = "black", size = 1, fill = NA) +
  theme_void() +
  labs(
    title = params$area_name
  )

#displays maps
city_map + area_map
 
```
::::

# Service Requests

The 311 Service Requests describe complains about trash in Baltimore City. 
The type of complains included in this analysis include Dirty Alleys, Dirty Streets, Illegal Dumping, and Sanitation Property. 

The location and the type of 311 service requests within the **`r area$name` `r params$area_type`**
over the past `r months_prior` months is shown on the map below. 

<!-- Beginning of Requests div -->
::::{id="service_requests"} 
:::{id="col1"}
```{r service_requests}
#Creates map of service requests colored by request type
area_requests %>% 
  ggplot() +
  geom_sf(data = blocks, fill = NA, color = "black") +        #Blocks layer
  geom_sf(data = area, color = "black", size = 1.25, fill = NA) +  #Neighborhood outline layer
  geom_sf(aes(color = sr_type)) +
  theme_void() +
  labs(
    title = "Area requests by type",
    color = "Service Request Type"
  )

#Counts the total number of area requests
total_requests <- nrow(area_requests)
```
:::

:::{id="col2"}
**`r total_requests`** Service Requests were made in `r area$name` over the past **`r months_prior` months**.
:::

```{r sr_request_types}
#Plots the service requests types in the chosen area
area_requests %>%
  st_drop_geometry() %>%
  count(sr_type, sort = TRUE) %>%
  ggplot() +
  geom_col(aes(x = reorder(sr_type, n), y = n, fill = sr_type), show.legend = FALSE) +
  ggtitle("Service Requests") +
  xlab("Request Type") +
  ylab("Total Requests") +
  labs(
       fill = "Request Type"
       )
```
::::
<!-- End of Requests div -->



# ECB Citations

The ECB Citations measure the city's code enforcement activities. This analysis focuses on the following citations: 
Bulk Trash, Exterior Sanitary Maintenance, Occupant Trash Disposal, and Trash Accumulation.  

The location and the type of ECB Citations within the **`r area$name` `r params$area_type`**
over the past `r months_prior` months is shown on the map below. 

<!-- Beginning of Citations div -->
::::{id="ecb_citations"} 
:::{id="col1"}
```{r citations}
#Maps the area citations
area_citations %>% 
  ggplot() +
  geom_sf(data = blocks, fill = NA, color = "black") +        #Blocks layer
  geom_sf(data = area, color = "black", size = 1.25, fill = NA) +  #Neighborhood outline layer
  geom_sf(aes(color = description)) +
  area_layer +
  theme_void() +
  labs(
    color = "Description",
    title = "ECB Citations",
    caption = citations_source
  ) +
  scale_color_manual(labels=c("Bulk Trash", "Exterior Sanitary Maintenance", "Trash Accumulation"),
                     values = c("#fb746b", "#2b9649", "#6ea1f9"))

#Counts the total number of area citations
total_citations <- nrow(area_citations)
```
:::

:::{id="col2"}
**`r total_citations`** ECB Citations were made in `r area$name` over the past **`r months_prior` months**.
:::

```{r ecb_citations_types}
#Plots the citation types in the chosen area
#How to modify the x-axis marks to make them look like the map's legend? -FIX THIS.

area_citations %>%
  st_drop_geometry() %>%
  count(description, sort = TRUE) %>%
  ggplot() +
  geom_col(aes(x = reorder(description, n), y = n, fill = description), show.legend = FALSE) +
  ggtitle("ECB Citations") +
  xlab("Citation Type") +
  ylab("Total Citations") +
  labs(
       fill = "Citation Type",
       caption = citations_source 
       ) 
```
::::
<!-- End of Citations div -->



# Trash Issues

```{r trash_issues}


```

# Nearby Areas

```{r compare_with_nearby_areas}


```

```{r lower_requests_and_citations}


```

:::::
